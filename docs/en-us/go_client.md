# Golang client

If you want to create/get/update/delete those OpenKruise resources in a Golang project or list-watch them using informer,
you may need a Golang client for OpenKruise.

Although Kruise have generated clientset/informers/listers in this [pkg/client](https://github.com/openkruise/kruise/tree/master/pkg/client) directory, we strongly deprecate the use of this client, for it will brings the whole kruise repo into your `go.mod` or `vendor`, which might cause dependencies more complicated.

We recommend users just use [kruise-api](https://github.com/openkruise/kruise-api) which only includes schema of the API types that are served by Kruise.

The [kruise-api](https://github.com/openkruise/kruise-api) library is the canonical location of the Kruise API definition.
Actually, it is synced from `https://github.com/openkruise/kruise/tree/master/pkg/apis`. All changes must be made in the latter. The former is read-only.

## Usage

[controller-runtime](https://github.com/kubernetes-sigs/controller-runtime) is the best way to use `kruise-api`:

- If your project is generated by [kubebuilder](https://github.com/kubernetes-sigs/kubebuilder) or [operator-sdk](https://github.com/operator-framework/operator-sdk), it means `controller-runtime` is already imported in your repo.
- Otherwrise, you may add it into your `go.mod` along with kruise-api.

### 1. Add kruise scheme

```go
import kruiseapps "github.com/openkruise/kruise-api/apps/v1alpha1"

// ...
_ = kruiseapps.AddToScheme(scheme)
```

### 2. New client

This is needed when use controller-runtime client directly.

If your project is generated by [kubebuilder](https://github.com/kubernetes-sigs/kubebuilder) or [operator-sdk](https://github.com/operator-framework/operator-sdk), you should get the client from `mgr.GetClient()` instead of the example below.

```go
import "sigs.k8s.io/controller-runtime/pkg/client"

apiClient, err := client.New(c, client.Options{Scheme: scheme})
```

### 3. Get/List

```go
import (
    kruiseapps "github.com/openkruise/kruise-api/apps/v1alpha1"
    "sigs.k8s.io/controller-runtime/pkg/client"
)

cloneSet := kruiseapps.CloneSet{}
err = apiClient.Get(context.TODO(), types.NamespacedName{Namespace: namespace, Name: name}, &cloneSet)

cloneSetList := kruiseapps.CloneSetList{}
err = apiClient.List(context.TODO(), &cloneSetList, client.InNamespace(instance.Namespace))
```

### 4. Create/Update/Delete

Create a new CloneSet:

```go
import kruiseapps "github.com/openkruise/kruise-api/apps/v1alpha1"

cloneSet := kruiseapps.CloneSet{
    // ...
}
err = apiClient.Create(context.TODO(), &cloneSet)
```

Update an existing CloneSet:

```go
import kruiseapps "github.com/openkruise/kruise-api/apps/v1alpha1"

// Get first
cloneSet := kruiseapps.CloneSet{}
if err = apiClient.Get(context.TODO(), types.NamespacedName{Namespace: namespace, Name: name}, &cloneSet); err != nil {
    return err
}

// Modify object, such as replicas or template
cloneSet.Spec.Replicas = utilpointer.Int32Ptr(5)

// Update
// This might get conflict, should retry it
if err = apiClient.Update(context.TODO(), &cloneSet); err != nil {
    return err
}
```

### 5. List watch and informer

If your project is generated by [kubebuilder](https://github.com/kubernetes-sigs/kubebuilder) or [operator-sdk](https://github.com/operator-framework/operator-sdk) and get the client from `mgr.GetClient()`, then methods like `Get`/`List` have already queried from informer instead of apiserver.
