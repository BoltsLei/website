{
  "filename": "deletion_protection.md",
  "__html": "<h1 id=\"deletion-protection\">Deletion Protection <a class=\"header-anchor\" href=\"#deletion-protection\">#</a></h1>\n<p><strong>FEATURE STATE:</strong> Kruise v0.9.0</p>\n<p>该功能提供了一个安全策略，用来在 Kubernetes 级联删除的机制下保护用户的资源和应用可用性。</p>\n<h2 id=\"%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F\">使用方式 <a class=\"header-anchor\" href=\"#%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F\">#</a></h2>\n<p>首先，需要在<a href=\"(./installation.html#optional%3A-feature-gate)\">安装或升级 Kruise</a> 的时候启用 <code>ResourcesDeletionProtection</code> feature-gate。</p>\n<p>然后，用户可以给一些特定资源对象加上 <code>policy.kruise.io/delete-protection</code> 标签，值可以是：</p>\n<ul>\n<li><code>Always</code>: 这个对象禁止被删除，除非上述 label 被去掉</li>\n<li><code>Cascading</code>: 这个对象如果还有可用的下属资源，则禁止被删除</li>\n</ul>\n<p>目前支持的资源类型、以及 cascading 级联关系如下：</p>\n<table>\n<thead>\n<tr>\n<th>Kind</th>\n<th>Group</th>\n<th>Version</th>\n<th><strong>Cascading</strong> judgement</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>Namespace</code></td>\n<td>core</td>\n<td>v1</td>\n<td>namespace 下是否还有正常的 Pod</td>\n</tr>\n<tr>\n<td><code>CustomResourceDefinition</code></td>\n<td><a href=\"http://apiextensions.k8s.io\">apiextensions.k8s.io</a></td>\n<td>v1beta1, v1</td>\n<td>CRD 下是否还有存量的 CR</td>\n</tr>\n<tr>\n<td><code>Deployment</code></td>\n<td>apps</td>\n<td>v1</td>\n<td>replicas 是否为 0</td>\n</tr>\n<tr>\n<td><code>StatefulSet</code></td>\n<td>apps</td>\n<td>v1</td>\n<td>replicas 是否为 0</td>\n</tr>\n<tr>\n<td><code>ReplicaSet</code></td>\n<td>apps</td>\n<td>v1</td>\n<td>replicas 是否为 0</td>\n</tr>\n<tr>\n<td><code>CloneSet</code></td>\n<td><a href=\"http://apps.kruise.io\">apps.kruise.io</a></td>\n<td>v1alpha1</td>\n<td>replicas 是否为 0</td>\n</tr>\n<tr>\n<td><code>StatefulSet</code></td>\n<td><a href=\"http://apps.kruise.io\">apps.kruise.io</a></td>\n<td>v1alpha1, v1beta1</td>\n<td>replicas 是否为 0</td>\n</tr>\n<tr>\n<td><code>UnitedDeployment</code></td>\n<td><a href=\"http://apps.kruise.io\">apps.kruise.io</a></td>\n<td>v1alpha1</td>\n<td>replicas 是否为 0</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"%E9%A3%8E%E9%99%A9\">风险 <a class=\"header-anchor\" href=\"#%E9%A3%8E%E9%99%A9\">#</a></h2>\n<p>通过 <a href=\"https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#webhook-configuration\">webhook configuration</a> 的 <code>objectSelector</code> 字段，\nKruise webhook 只会拦截处理带有 <code>policy.kruise.io/delete-protection</code> 标签的 <code>Namespace/CustomResourceDefinition/Deployment/StatefulSet/ReplicaSet</code> 资源。</p>\n<p>因此，如果所有 kruise-manager pod 都挂了或者处于异常的状态，kube-apiserver 调用 deletion webhook 失败，\n只有带有 <code>policy.kruise.io/delete-protection</code> 标签的上述资源才会暂时无法删除。</p>\n",
  "link": "/zh-cn/docs/deletion_protection.html",
  "meta": {
    "title": "Deletion Protection"
  }
}