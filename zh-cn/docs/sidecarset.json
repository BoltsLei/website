{
  "filename": "sidecarset.md",
  "__html": "<h1>SidecarSet</h1>\n<p>这个控制器支持通过 admission webhook 来自动为集群中创建的符合条件的 Pod 注入 sidecar 容器。\n这个注入过程和 <a href=\"https://istio.io/docs/setup/kubernetes/additional-setup/sidecar-injection/\">istio</a>\n的自动注入方式很类似。\n除了在 Pod 创建时候注入外，SidecarSet 还提供了为运行时 Pod 原地升级其中已经注入的 sidecar 容器镜像的能力。</p>\n<p>简单来说，SidecarSet 将 sidecar 容器的定义和生命周期与业务容器解耦。\n它主要用于管理无状态的 sidecar 容器，比如监控、日志等 agent。</p>\n<p>SidecarSet spec 定义如下：</p>\n<pre><code class=\"language-go\"><span class=\"hljs-keyword\">type</span> SidecarSetSpec <span class=\"hljs-keyword\">struct</span> {\n\t<span class=\"hljs-comment\">// selector is a label query over pods that should be injected</span>\n\tSelector *metav1.LabelSelector <span class=\"hljs-string\">`json:\"selector,omitempty\"`</span>\n\n\t<span class=\"hljs-comment\">// Containers is the list of init containers to be injected into the selected pod</span>\n\t<span class=\"hljs-comment\">// We will inject those containers by their name in ascending order</span>\n\t<span class=\"hljs-comment\">// We only inject init containers when a new pod is created, it does not apply to any existing pod</span>\n\tInitContainers []SidecarContainer <span class=\"hljs-string\">`json:\"initContainers,omitempty\"`</span>\n\n\t<span class=\"hljs-comment\">// Containers is the list of sidecar containers to be injected into the selected pod</span>\n\tContainers []SidecarContainer <span class=\"hljs-string\">`json:\"containers,omitempty\"`</span>\n\n\t<span class=\"hljs-comment\">// List of volumes that can be mounted by sidecar containers</span>\n\tVolumes []corev1.Volume <span class=\"hljs-string\">`json:\"volumes,omitempty\"`</span>\n\n\t<span class=\"hljs-comment\">// Paused indicates that the sidecarset is paused and will not be processed by the sidecarset controller.</span>\n\tPaused <span class=\"hljs-keyword\">bool</span> <span class=\"hljs-string\">`json:\"paused,omitempty\"`</span>\n\n\t<span class=\"hljs-comment\">// The sidecarset strategy to use to replace existing pods with new ones.</span>\n\tStrategy SidecarSetUpdateStrategy <span class=\"hljs-string\">`json:\"strategy,omitempty\"`</span>\n}\n\n<span class=\"hljs-keyword\">type</span> SidecarContainer <span class=\"hljs-keyword\">struct</span> {\n    corev1.Container\n}\n</code></pre>\n<p>注意，sidecar 的注入只会发生在 Pod 创建阶段，并且只有 Pod spec 会被更新，不会影响 Pod 所属的 workload template 模板。</p>\n<h2>范例</h2>\n<h3>创建 SidecarSet</h3>\n<p>如下的 <code>sidecarset.yaml</code> 定义了一个 SidecarSet，其中包括了一个名为 <code>sidecar1</code> 的 sidecar 容器：</p>\n<pre><code class=\"language-yaml\"><span class=\"hljs-comment\"># sidecarset.yaml</span>\n<span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">apps.kruise.io/v1alpha1</span>\n<span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">SidecarSet</span>\n<span class=\"hljs-attr\">metadata:</span>\n  <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">test-sidecarset</span>\n<span class=\"hljs-attr\">spec:</span>\n  <span class=\"hljs-attr\">selector:</span>\n    <span class=\"hljs-attr\">matchLabels:</span>\n      <span class=\"hljs-attr\">app:</span> <span class=\"hljs-string\">nginx</span>\n  <span class=\"hljs-attr\">strategy:</span>\n    <span class=\"hljs-attr\">rollingUpdate:</span>\n      <span class=\"hljs-attr\">maxUnavailable:</span> <span class=\"hljs-number\">2</span>\n  <span class=\"hljs-attr\">containers:</span>\n  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">sidecar1</span>\n    <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">centos:6.7</span>\n    <span class=\"hljs-attr\">command:</span> <span class=\"hljs-string\">[\"sleep\",</span> <span class=\"hljs-string\">\"999d\"</span><span class=\"hljs-string\">]</span> <span class=\"hljs-comment\"># do nothing at all</span>\n    <span class=\"hljs-attr\">volumeMounts:</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">log-volume</span>\n      <span class=\"hljs-attr\">mountPath:</span> <span class=\"hljs-string\">/var/log</span>\n  <span class=\"hljs-attr\">volumes:</span> <span class=\"hljs-comment\"># this field will be merged into pod.spec.volumes</span>\n  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">log-volume</span>\n    <span class=\"hljs-attr\">emptyDir:</span> <span class=\"hljs-string\">{}</span>\n</code></pre>\n<p>创建这个 YAML:</p>\n<pre><code class=\"language-shell\">kubectl apply -f sidecarset.yaml\n</code></pre>\n<h3>创建 Pod</h3>\n<p>定义一个匹配 SidecarSet selector 的 Pod：</p>\n<pre><code class=\"language-yaml\"><span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">v1</span>\n<span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">Pod</span>\n<span class=\"hljs-attr\">metadata:</span>\n  <span class=\"hljs-attr\">labels:</span>\n    <span class=\"hljs-attr\">app:</span> <span class=\"hljs-string\">nginx</span> <span class=\"hljs-comment\"># matches the SidecarSet's selector</span>\n  <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">test-pod</span>\n<span class=\"hljs-attr\">spec:</span>\n  <span class=\"hljs-attr\">containers:</span>\n  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">app</span>\n    <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">nginx:1.15.1</span>\n</code></pre>\n<p>创建这个 Pod，你会发现其中被注入了 <code>sidecar1</code> 容器：</p>\n<pre><code class=\"language-shell\"><span class=\"hljs-meta\">$</span><span class=\"bash\"> kubectl get pod</span>\nNAME       READY   STATUS    RESTARTS   AGE\ntest-pod   2/2     Running   0          118s\n</code></pre>\n<p>此时，SidecarSet status 被更新为：</p>\n<pre><code class=\"language-shell\"><span class=\"hljs-meta\">$</span><span class=\"bash\"> kubectl get sidecarset <span class=\"hljs-built_in\">test</span>-sidecarset -o yaml | grep -A4 status</span>\nstatus:\n  matchedPods: 1\n  observedGeneration: 1\n  readyPods: 1\n  updatedPods: 1\n</code></pre>\n<h3>更新 SidecarSet</h3>\n<p>使用 <code>kubectl edit sidecarset test-sidecarset</code> 来将 SidecarSet 中的 image 从 <code>centos:6.7</code> 更新为 <code>centos:6.8</code>，你会发现已经注入 Pod 中的 sidecar 镜像被原地升级。</p>\n<p>如果用户更新了 <code>spec.containers</code> 中除 image 之外的字段，那么 SidecarSet 是做到无法原地升级的，只能等到 Pod 下一次被删除、重建的时候重新注入（比如用 Deployment/CloneSet 做重建升级）。\n这种行为被 SidecarSet 称为 <strong>懒升级</strong> 模式。</p>\n",
  "link": "/zh-cn/docs/sidecarset.html",
  "meta": {
    "title": "SidecarSet"
  }
}