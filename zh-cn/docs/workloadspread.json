{
  "filename": "workloadspread.md",
  "__html": "<h1 id=\"workloadspread\">WorkloadSpread <a class=\"header-anchor\" href=\"#workloadspread\">#</a></h1>\n<p>WorkloadSpread可以用来约束无状态Workload的区域分布，赋予单一workload的多域部署和弹性部署的能力。</p>\n<p>WorkloadSpread与Kruise社区的UnitedDeployment功能相似，每一个WorkloadSpread定义多个区域（定义为<code>subset</code>），\n<code>subset</code>对应一个<code>maxReplicas</code>数量。WorkloadSpread利用Webhook注入<code>subset</code>定义的域信息，且控制Pod的扩缩容顺序。</p>\n<p>目前支持的Workload类型：<code>CloneSet</code>、<code>Deployment</code>、<code>ReplicaSet</code>。</p>\n<p>API定义：<a href=\"https://github.com/openkruise/kruise/blob/819125ddbd4fb4ffb5f3b1ecf03490349a8f6727/apis/apps/v1alpha1/workloadspread_types.go\">https://github.com/openkruise/kruise/blob/819125ddbd4fb4ffb5f3b1ecf03490349a8f6727/apis/apps/v1alpha1/workloadspread_types.go</a></p>\n<h2 id=\"workloadspread-spec\">WorkloadSpread Spec <a class=\"header-anchor\" href=\"#workloadspread-spec\">#</a></h2>\n<pre><code class=\"language-yaml\"><span class=\"hljs-string\">//</span> <span class=\"hljs-string\">WorkloadSpreadSpec</span> <span class=\"hljs-string\">defines</span> <span class=\"hljs-string\">the</span> <span class=\"hljs-string\">desired</span> <span class=\"hljs-string\">state</span> <span class=\"hljs-string\">of</span> <span class=\"hljs-string\">WorkloadSpread.</span>\n<span class=\"hljs-string\">type</span> <span class=\"hljs-string\">WorkloadSpreadSpec</span> <span class=\"hljs-string\">struct</span> <span class=\"hljs-string\">{</span>\n\t<span class=\"hljs-string\">//</span> <span class=\"hljs-string\">TargetReference</span> <span class=\"hljs-string\">is</span> <span class=\"hljs-string\">the</span> <span class=\"hljs-string\">target</span> <span class=\"hljs-string\">workload</span> <span class=\"hljs-string\">that</span> <span class=\"hljs-string\">WorkloadSpread</span> <span class=\"hljs-string\">want</span> <span class=\"hljs-string\">to</span> <span class=\"hljs-string\">control.</span>\n\t<span class=\"hljs-string\">TargetReference</span> <span class=\"hljs-string\">*TargetReference</span> <span class=\"hljs-string\">`json:\"targetRef\"`</span>\n\n\t<span class=\"hljs-string\">//</span> <span class=\"hljs-string\">Subsets</span> <span class=\"hljs-string\">describes</span> <span class=\"hljs-string\">the</span> <span class=\"hljs-string\">pods</span> <span class=\"hljs-string\">distribution</span> <span class=\"hljs-string\">details</span> <span class=\"hljs-string\">between</span> <span class=\"hljs-string\">each</span> <span class=\"hljs-string\">of</span> <span class=\"hljs-string\">subsets.</span>\n\t<span class=\"hljs-string\">Subsets</span> <span class=\"hljs-string\">[]WorkloadSpreadSubset</span> <span class=\"hljs-string\">`json:\"subsets\"`</span>\n\n\t<span class=\"hljs-string\">//</span> <span class=\"hljs-string\">ScheduleStrategy</span> <span class=\"hljs-string\">indicates</span> <span class=\"hljs-string\">the</span> <span class=\"hljs-string\">strategy</span> <span class=\"hljs-string\">the</span> <span class=\"hljs-string\">WorkloadSpread</span> <span class=\"hljs-string\">used</span> <span class=\"hljs-string\">to</span> <span class=\"hljs-string\">preform</span> <span class=\"hljs-string\">the</span> <span class=\"hljs-string\">schedule</span> <span class=\"hljs-string\">between</span> <span class=\"hljs-string\">each</span> <span class=\"hljs-string\">of</span> <span class=\"hljs-string\">subsets.</span>\n\t<span class=\"hljs-string\">//</span> <span class=\"hljs-string\">+optional</span>\n\t<span class=\"hljs-string\">ScheduleStrategy</span> <span class=\"hljs-string\">WorkloadSpreadScheduleStrategy</span> <span class=\"hljs-string\">`json:\"scheduleStrategy,omitempty\"`</span>\n<span class=\"hljs-string\">}</span>\n</code></pre>\n<p><strong>注意</strong>：<code>targetRef</code>不可以变更，且一个Workload只能对应一个WorkloadSpread。</p>\n<h3 id=\"subset\">Subset <a class=\"header-anchor\" href=\"#subset\">#</a></h3>\n<pre><code class=\"language-yaml\"><span class=\"hljs-string\">//</span> <span class=\"hljs-string\">WorkloadSpreadSubset</span> <span class=\"hljs-string\">defines</span> <span class=\"hljs-string\">the</span> <span class=\"hljs-string\">details</span> <span class=\"hljs-string\">of</span> <span class=\"hljs-string\">a</span> <span class=\"hljs-string\">subset.</span>\n<span class=\"hljs-string\">type</span> <span class=\"hljs-string\">WorkloadSpreadSubset</span> <span class=\"hljs-string\">struct</span> <span class=\"hljs-string\">{</span>\n\t<span class=\"hljs-string\">//</span> <span class=\"hljs-string\">Name</span> <span class=\"hljs-string\">should</span> <span class=\"hljs-string\">be</span> <span class=\"hljs-string\">unique</span> <span class=\"hljs-string\">between</span> <span class=\"hljs-string\">all</span> <span class=\"hljs-string\">of</span> <span class=\"hljs-string\">the</span> <span class=\"hljs-string\">subsets</span> <span class=\"hljs-string\">under</span> <span class=\"hljs-string\">one</span> <span class=\"hljs-string\">WorkloadSpread.</span>\n\t<span class=\"hljs-string\">Name</span> <span class=\"hljs-string\">string</span> <span class=\"hljs-string\">`json:\"name\"`</span>\n\n\t<span class=\"hljs-string\">//</span> <span class=\"hljs-string\">Indicates</span> <span class=\"hljs-string\">the</span> <span class=\"hljs-string\">node</span> <span class=\"hljs-string\">required</span> <span class=\"hljs-string\">selector</span> <span class=\"hljs-string\">to</span> <span class=\"hljs-string\">form</span> <span class=\"hljs-string\">the</span> <span class=\"hljs-string\">subset.</span>\n\t<span class=\"hljs-string\">//</span> <span class=\"hljs-string\">+optional</span>\n\t<span class=\"hljs-string\">RequiredNodeSelectorTerm</span> <span class=\"hljs-string\">*corev1.NodeSelectorTerm</span> <span class=\"hljs-string\">`json:\"requiredNodeSelectorTerm,omitempty\"`</span>\n\n\t<span class=\"hljs-string\">//</span> <span class=\"hljs-string\">Indicates</span> <span class=\"hljs-string\">the</span> <span class=\"hljs-string\">node</span> <span class=\"hljs-string\">preferred</span> <span class=\"hljs-string\">selector</span> <span class=\"hljs-string\">to</span> <span class=\"hljs-string\">form</span> <span class=\"hljs-string\">the</span> <span class=\"hljs-string\">subset.</span>\n\t<span class=\"hljs-string\">//</span> <span class=\"hljs-string\">+optional</span>\n\t<span class=\"hljs-string\">PreferredNodeSelectorTerms</span> <span class=\"hljs-string\">[]corev1.PreferredSchedulingTerm</span> <span class=\"hljs-string\">`json:\"preferredNodeSelectorTerms,omitempty\"`</span>\n\n\t<span class=\"hljs-string\">//</span> <span class=\"hljs-string\">Indicates</span> <span class=\"hljs-string\">the</span> <span class=\"hljs-string\">tolerations</span> <span class=\"hljs-string\">the</span> <span class=\"hljs-string\">pods</span> <span class=\"hljs-string\">under</span> <span class=\"hljs-string\">this</span> <span class=\"hljs-string\">subset</span> <span class=\"hljs-string\">have.</span>\n\t<span class=\"hljs-string\">//</span> <span class=\"hljs-string\">+optional</span>\n\t<span class=\"hljs-string\">Tolerations</span> <span class=\"hljs-string\">[]corev1.Toleration</span> <span class=\"hljs-string\">`json:\"tolerations,omitempty\"`</span>\n\n\t<span class=\"hljs-string\">//</span> <span class=\"hljs-string\">MaxReplicas</span> <span class=\"hljs-string\">indicates</span> <span class=\"hljs-string\">the</span> <span class=\"hljs-string\">desired</span> <span class=\"hljs-string\">max</span> <span class=\"hljs-string\">replicas</span> <span class=\"hljs-string\">of</span> <span class=\"hljs-string\">this</span> <span class=\"hljs-string\">subset.</span>\n\t<span class=\"hljs-string\">//</span> <span class=\"hljs-string\">+optional</span>\n\t<span class=\"hljs-string\">MaxReplicas</span> <span class=\"hljs-string\">*intstr.IntOrString</span> <span class=\"hljs-string\">`json:\"maxReplicas,omitempty\"`</span>\n\n\t<span class=\"hljs-string\">//</span> <span class=\"hljs-string\">Patch</span> <span class=\"hljs-string\">indicates</span> <span class=\"hljs-string\">patching</span> <span class=\"hljs-string\">podTemplate</span> <span class=\"hljs-string\">to</span> <span class=\"hljs-string\">the</span> <span class=\"hljs-string\">Pod.</span>\n\t<span class=\"hljs-string\">//</span> <span class=\"hljs-string\">+optional</span>\n\t<span class=\"hljs-string\">Patch</span> <span class=\"hljs-string\">runtime.RawExtension</span> <span class=\"hljs-string\">`json:\"patch,omitempty\"`</span>\n<span class=\"hljs-string\">}</span>\n</code></pre>\n<p><code>MaxReplicas</code>：当前版本暂不支持百分比；若设置为空，代表不限制subset的副本数。</p>\n<p><code>Patch</code>: 自定义<code>subset</code>的Pod配置，可以是Annotations、Labels、Env等。</p>\n<pre><code class=\"language-yaml\"><span class=\"hljs-comment\"># patch metadata:</span>\n<span class=\"hljs-attr\">patch:</span>\n  <span class=\"hljs-attr\">metadata:</span>\n    <span class=\"hljs-attr\">labels:</span>\n      <span class=\"hljs-attr\">xxx-specific-label:</span> <span class=\"hljs-string\">xxx</span>\n</code></pre>\n<pre><code class=\"language-yaml\"><span class=\"hljs-comment\"># patch container resources:</span>\n<span class=\"hljs-attr\">patch:</span>\n  <span class=\"hljs-attr\">spec:</span>\n    <span class=\"hljs-attr\">containers:</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">main</span>\n      <span class=\"hljs-attr\">resources:</span>\n        <span class=\"hljs-attr\">limit:</span>\n          <span class=\"hljs-attr\">cpu:</span> <span class=\"hljs-string\">\"2\"</span>\n          <span class=\"hljs-attr\">memory:</span> <span class=\"hljs-string\">800Mi</span>\n</code></pre>\n<pre><code class=\"language-yaml\"><span class=\"hljs-comment\"># patch container environments:</span>\n<span class=\"hljs-attr\">patch:</span>\n  <span class=\"hljs-attr\">spec:</span>\n    <span class=\"hljs-attr\">containers:</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">main</span>\n      <span class=\"hljs-attr\">env:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">K8S_CONTAINER_NAME</span>\n        <span class=\"hljs-attr\">value:</span> <span class=\"hljs-string\">main</span>\n</code></pre>\n<h2 id=\"%E6%A8%A1%E6%8B%9F%E8%B0%83%E5%BA%A6%E5%92%8Creschedule\">模拟调度和Reschedule <a class=\"header-anchor\" href=\"#%E6%A8%A1%E6%8B%9F%E8%B0%83%E5%BA%A6%E5%92%8Creschedule\">#</a></h2>\n<p>WorkloadSpread提供了两种调度策略，默认为<code>Fixed</code>:</p>\n<h3 id=\"fixed%3A\">Fixed: <a class=\"header-anchor\" href=\"#fixed%3A\">#</a></h3>\n<p>Workload严格按照<code>subset</code>定义分布。</p>\n<h3 id=\"adaptive\">Adaptive <a class=\"header-anchor\" href=\"#adaptive\">#</a></h3>\n<pre><code class=\"language-yaml\"><span class=\"hljs-string\">//</span> <span class=\"hljs-string\">AdaptiveWorkloadSpreadStrategy</span> <span class=\"hljs-string\">is</span> <span class=\"hljs-string\">used</span> <span class=\"hljs-string\">to</span> <span class=\"hljs-string\">communicate</span> <span class=\"hljs-string\">parameters</span> <span class=\"hljs-string\">when</span> <span class=\"hljs-string\">Type</span> <span class=\"hljs-string\">is</span> <span class=\"hljs-string\">AdaptiveWorkloadSpreadScheduleStrategyType.</span>\n<span class=\"hljs-string\">type</span> <span class=\"hljs-string\">AdaptiveWorkloadSpreadStrategy</span> <span class=\"hljs-string\">struct</span> <span class=\"hljs-string\">{</span>\n\t<span class=\"hljs-string\">//</span> <span class=\"hljs-string\">DisableSimulationSchedule</span> <span class=\"hljs-string\">indicates</span> <span class=\"hljs-string\">whether</span> <span class=\"hljs-string\">to</span> <span class=\"hljs-string\">disable</span> <span class=\"hljs-string\">the</span> <span class=\"hljs-string\">feature</span> <span class=\"hljs-string\">of</span> <span class=\"hljs-string\">simulation</span> <span class=\"hljs-string\">schedule.</span>\n\t<span class=\"hljs-string\">//</span> <span class=\"hljs-string\">Default</span> <span class=\"hljs-string\">is</span> <span class=\"hljs-literal\">false</span>.\n\t<span class=\"hljs-string\">//</span> <span class=\"hljs-string\">Webhook</span> <span class=\"hljs-string\">can</span> <span class=\"hljs-string\">take</span> <span class=\"hljs-string\">a</span> <span class=\"hljs-string\">simple</span> <span class=\"hljs-string\">general</span> <span class=\"hljs-string\">predicates</span> <span class=\"hljs-string\">to</span> <span class=\"hljs-string\">check</span> <span class=\"hljs-string\">whether</span> <span class=\"hljs-string\">Pod</span> <span class=\"hljs-string\">can</span> <span class=\"hljs-string\">be</span> <span class=\"hljs-string\">scheduled</span> <span class=\"hljs-string\">into</span> <span class=\"hljs-string\">this</span> <span class=\"hljs-string\">subset,</span>\n\t<span class=\"hljs-string\">//</span> <span class=\"hljs-string\">but</span> <span class=\"hljs-string\">it</span> <span class=\"hljs-string\">just</span> <span class=\"hljs-string\">considers</span> <span class=\"hljs-string\">the</span> <span class=\"hljs-string\">Node</span> <span class=\"hljs-string\">resource</span> <span class=\"hljs-string\">and</span> <span class=\"hljs-string\">cannot</span> <span class=\"hljs-string\">replace</span> <span class=\"hljs-string\">scheduler</span> <span class=\"hljs-string\">to</span> <span class=\"hljs-string\">do</span> <span class=\"hljs-string\">richer</span> <span class=\"hljs-string\">predicates</span> <span class=\"hljs-string\">practically.</span>\n\t<span class=\"hljs-string\">//</span> <span class=\"hljs-string\">+optional</span>\n\t<span class=\"hljs-string\">DisableSimulationSchedule</span> <span class=\"hljs-string\">bool</span> <span class=\"hljs-string\">`json:\"disableSimulationSchedule,omitempty\"`</span>\n\n\t<span class=\"hljs-string\">//</span> <span class=\"hljs-string\">RescheduleCriticalSeconds</span> <span class=\"hljs-string\">indicates</span> <span class=\"hljs-string\">how</span> <span class=\"hljs-string\">long</span> <span class=\"hljs-string\">controller</span> <span class=\"hljs-string\">will</span> <span class=\"hljs-string\">reschedule</span> <span class=\"hljs-string\">a</span> <span class=\"hljs-string\">schedule</span> <span class=\"hljs-string\">failed</span> <span class=\"hljs-string\">Pod</span> <span class=\"hljs-string\">to</span> <span class=\"hljs-string\">the</span> <span class=\"hljs-string\">subset</span> <span class=\"hljs-string\">that</span> <span class=\"hljs-string\">has</span>\n\t<span class=\"hljs-string\">//</span> <span class=\"hljs-string\">redundant</span> <span class=\"hljs-string\">capacity</span> <span class=\"hljs-string\">after</span> <span class=\"hljs-string\">the</span> <span class=\"hljs-string\">subset</span> <span class=\"hljs-string\">where</span> <span class=\"hljs-string\">the</span> <span class=\"hljs-string\">Pod</span> <span class=\"hljs-string\">lives.</span> <span class=\"hljs-string\">If</span> <span class=\"hljs-string\">a</span> <span class=\"hljs-string\">Pod</span> <span class=\"hljs-string\">was</span> <span class=\"hljs-string\">scheduled</span> <span class=\"hljs-string\">failed</span> <span class=\"hljs-string\">and</span> <span class=\"hljs-string\">still</span> <span class=\"hljs-string\">in</span> <span class=\"hljs-string\">a</span> <span class=\"hljs-string\">unschedulabe</span> <span class=\"hljs-string\">status</span>\n\t<span class=\"hljs-string\">//</span> <span class=\"hljs-string\">over</span> <span class=\"hljs-string\">RescheduleCriticalSeconds</span> <span class=\"hljs-string\">duration,</span> <span class=\"hljs-string\">the</span> <span class=\"hljs-string\">controller</span> <span class=\"hljs-string\">will</span> <span class=\"hljs-string\">reschedule</span> <span class=\"hljs-string\">it</span> <span class=\"hljs-string\">to</span> <span class=\"hljs-string\">a</span> <span class=\"hljs-string\">suitable</span> <span class=\"hljs-string\">subset.</span>\n\t<span class=\"hljs-string\">//</span> <span class=\"hljs-string\">+optional</span>\n\t<span class=\"hljs-string\">RescheduleCriticalSeconds</span> <span class=\"hljs-string\">*int32</span> <span class=\"hljs-string\">`json:\"rescheduleCriticalSeconds,omitempty\"`</span>\n<span class=\"hljs-string\">}</span>\n</code></pre>\n<p><strong>模拟调度</strong>： Kruise会对<code>subset</code>的Node资源做简单过滤，若资源不足会调度到下一个<code>subset</code>。</p>\n<p><strong>Reschedule</strong>：Kruise检查<code>subset</code>调度失败的Pod，若超过用户定义的时间就调度到其他<code>subset</code>。</p>\n<h2 id=\"%E7%8E%AF%E5%A2%83%E8%A6%81%E6%B1%82\">环境要求 <a class=\"header-anchor\" href=\"#%E7%8E%AF%E5%A2%83%E8%A6%81%E6%B1%82\">#</a></h2>\n<h3 id=\"pod-webhook\">Pod Webhook <a class=\"header-anchor\" href=\"#pod-webhook\">#</a></h3>\n<p>WorkloadSpread利用<code>webhook</code>向Pod注入域规则并且关心Pod的驱逐和删除事件。</p>\n<p>如果<code>PodWebhook</code> feature-gate被设置为<code>false</code>，WorkloadSpread也将不可用。</p>\n<h3 id=\"deletion-cost-feature\">deletion-cost feature <a class=\"header-anchor\" href=\"#deletion-cost-feature\">#</a></h3>\n<p>CloneSet已经支持该特性。</p>\n<p>其他native workload需kubernetes version &gt;= 1.21。1.21版本需要开启 <code>PodDeletionCost</code> feature-gate。自1.22起默认开启。</p>\n<h2 id=\"%E6%89%A9%E7%BC%A9%E5%AE%B9%E9%A1%BA%E5%BA%8F%EF%BC%9A\">扩缩容顺序： <a class=\"header-anchor\" href=\"#%E6%89%A9%E7%BC%A9%E5%AE%B9%E9%A1%BA%E5%BA%8F%EF%BC%9A\">#</a></h2>\n<h3 id=\"%E6%89%A9%E5%AE%B9\">扩容 <a class=\"header-anchor\" href=\"#%E6%89%A9%E5%AE%B9\">#</a></h3>\n<ul>\n<li>按照<code>spec.subsets</code>中<code>subset</code>定义的顺序调度Pod，当前<code>subset</code>的Pod数量达到<code>maxReplicas</code>时再调度到下一个<code>subset</code>。</li>\n</ul>\n<h3 id=\"%E7%BC%A9%E5%AE%B9\">缩容 <a class=\"header-anchor\" href=\"#%E7%BC%A9%E5%AE%B9\">#</a></h3>\n<ul>\n<li>当<code>subset</code>的副本数大于定义的maxReplicas时，优先缩容多余的Pod。</li>\n<li>按照<code>spec.subsets</code>中<code>subset</code>定义的顺序，后面的<code>subset</code>的Pod先于前面的被删除。</li>\n</ul>\n<h2 id=\"%E4%BE%8B%E5%AD%90\">例子 <a class=\"header-anchor\" href=\"#%E4%BE%8B%E5%AD%90\">#</a></h2>\n<h3 id=\"%E5%BC%B9%E6%80%A7%E9%83%A8%E7%BD%B2\">弹性部署 <a class=\"header-anchor\" href=\"#%E5%BC%B9%E6%80%A7%E9%83%A8%E7%BD%B2\">#</a></h3>\n<p>zone-a（ack）固定100个Pod，zone-b（eci）做弹性区域</p>\n<ol>\n<li>创建WorkloadSpread实例</li>\n</ol>\n<pre><code class=\"language-yaml\"><span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">apps.kruise.io/v1alpha1</span>\n<span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">WorkloadSpread</span>\n<span class=\"hljs-attr\">metadta:</span>\n  <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">ws-demo</span>\n  <span class=\"hljs-attr\">namespace:</span> <span class=\"hljs-string\">deploy</span>\n<span class=\"hljs-attr\">spec:</span>\n  <span class=\"hljs-attr\">targetRef:</span> <span class=\"hljs-comment\"># 相同namespace下的workload</span>\n    <span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">apps.kruise.io/v1alpha1</span>\n    <span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">CloneSet</span>\n    <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">workload-xxx</span>\n  <span class=\"hljs-attr\">subsets:</span>\n  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">ack</span> <span class=\"hljs-comment\"># zone ack，最多100个副本。</span>\n    <span class=\"hljs-attr\">requiredNodeSelectorTerm:</span>\n      <span class=\"hljs-attr\">matchExpressions:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">key:</span> <span class=\"hljs-string\">topology.kubernetes.io/zone</span>\n        <span class=\"hljs-attr\">operator:</span> <span class=\"hljs-string\">In</span>\n        <span class=\"hljs-attr\">values:</span>\n        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">ack</span>\n    <span class=\"hljs-attr\">maxReplicas:</span> <span class=\"hljs-number\">100</span>\n    <span class=\"hljs-attr\">patch:</span> <span class=\"hljs-comment\"># 注入label</span>\n      <span class=\"hljs-attr\">metadata:</span>\n        <span class=\"hljs-attr\">labels:</span>\n          <span class=\"hljs-attr\">deploy/zone:</span> <span class=\"hljs-string\">ack</span>\n  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">eci</span> <span class=\"hljs-comment\"># 弹性区域eci，副本数量不限。</span>\n    <span class=\"hljs-attr\">requiredNodeSelectorTerm:</span>\n      <span class=\"hljs-attr\">matchExpressions:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">key:</span> <span class=\"hljs-string\">topology.kubernetes.io/zone</span>\n        <span class=\"hljs-attr\">operator:</span> <span class=\"hljs-string\">In</span>\n        <span class=\"hljs-attr\">values:</span>\n        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">eci</span>\n    <span class=\"hljs-attr\">patch:</span>\n      <span class=\"hljs-attr\">metadata:</span>\n        <span class=\"hljs-attr\">labels:</span>\n          <span class=\"hljs-attr\">deploy/zone:</span> <span class=\"hljs-string\">eci</span>\n</code></pre>\n<ol start=\"2\">\n<li>创建workload，副本数可以自由调整。</li>\n</ol>\n<h4 id=\"%E9%83%A8%E7%BD%B2%E6%95%88%E6%9E%9C\">部署效果 <a class=\"header-anchor\" href=\"#%E9%83%A8%E7%BD%B2%E6%95%88%E6%9E%9C\">#</a></h4>\n<ul>\n<li>当replicas &lt;= 100 时，Pod被调度到ack上。</li>\n<li>当replicas &gt; 100 时，100个在ack，多余的Pod在弹性域eci。</li>\n<li>缩容时优先从弹性域eci上缩容。</li>\n</ul>\n<h3 id=\"%E5%A4%9A%E5%9F%9F%E9%83%A8%E7%BD%B2\">多域部署 <a class=\"header-anchor\" href=\"#%E5%A4%9A%E5%9F%9F%E9%83%A8%E7%BD%B2\">#</a></h3>\n<p>分别部署100个副本的Pod到两个机房（zone-a, zone-b）</p>\n<ol>\n<li>创建WorkloadSpread实例</li>\n</ol>\n<pre><code class=\"language-yaml\"><span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">apps.kruise.io/v1alpha1</span>\n<span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">WorkloadSpread</span>\n<span class=\"hljs-attr\">metadta:</span>\n  <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">ws-demo</span>\n  <span class=\"hljs-attr\">namespace:</span> <span class=\"hljs-string\">deploy</span>\n<span class=\"hljs-attr\">spec:</span>\n  <span class=\"hljs-attr\">targetRef:</span> <span class=\"hljs-comment\"># 相同namespace下的workload</span>\n    <span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">apps.kruise.io/v1alpha1</span>\n    <span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">CloneSet</span>\n    <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">workload-xxx</span>\n  <span class=\"hljs-attr\">subsets:</span>\n  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">subset-a</span> <span class=\"hljs-comment\"># 区域A，100个副本。</span>\n    <span class=\"hljs-attr\">requiredNodeSelectorTerm:</span>\n      <span class=\"hljs-attr\">matchExpressions:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">key:</span> <span class=\"hljs-string\">topology.kubernetes.io/zone</span>\n        <span class=\"hljs-attr\">operator:</span> <span class=\"hljs-string\">In</span>\n        <span class=\"hljs-attr\">values:</span>\n        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">zone-a</span>\n    <span class=\"hljs-attr\">maxReplicas:</span> <span class=\"hljs-number\">100</span>\n    <span class=\"hljs-attr\">patch:</span>\n      <span class=\"hljs-attr\">metadata:</span>\n        <span class=\"hljs-attr\">labels:</span>\n          <span class=\"hljs-attr\">deploy/zone:</span> <span class=\"hljs-string\">zonb-a</span>\n  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">subset-b</span> <span class=\"hljs-comment\"># 区域B，100个副本。</span>\n    <span class=\"hljs-attr\">requiredNodeSelectorTerm:</span>\n      <span class=\"hljs-attr\">matchExpressions:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">key:</span> <span class=\"hljs-string\">topology.kubernetes.io/zone</span>\n        <span class=\"hljs-attr\">operator:</span> <span class=\"hljs-string\">In</span>\n        <span class=\"hljs-attr\">values:</span>\n        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">zone-b</span>\n    <span class=\"hljs-attr\">maxReplicas:</span> <span class=\"hljs-number\">100</span>\n    <span class=\"hljs-attr\">patch:</span>\n      <span class=\"hljs-attr\">metadata:</span>\n        <span class=\"hljs-attr\">labels:</span>\n          <span class=\"hljs-attr\">deploy/zone:</span> <span class=\"hljs-string\">zone-b</span>\n</code></pre>\n<ol start=\"2\">\n<li>\n<p>创建200副本的workload，或者对已有的workload执行滚动更新。</p>\n</li>\n<li>\n<p>如zone副本分布需要变动，先调整对应<code>subset</code>的<code>maxReplicas</code>，再调整workload副本数。</p>\n</li>\n</ol>\n",
  "link": "/zh-cn/docs/workloadspread.html",
  "meta": {
    "title": "WorkloadSpread"
  }
}